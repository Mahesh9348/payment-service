FROM nexus.nee.com/openjdk:8-jdk-alpine
VOLUME /tmp

# Install AppDynamics Java AppServer Agent
ENV APPSERVER_AGENT_HOME /opt/appdynamics/AppServerAgent/
ARG APPSERVER_AGENT_VERSION

ADD https://nexus.nee.com/repository/fplcom-releases/com/nee/utils/appd/AppServerAgent/${APPSERVER_AGENT_VERSION}/AppServerAgent-${APPSERVER_AGENT_VERSION}.zip /tmp/
RUN mkdir -p ${APPSERVER_AGENT_HOME} && \
unzip -oq /tmp/AppServerAgent-${APPSERVER_AGENT_VERSION}.zip -d ${APPSERVER_AGENT_HOME} && \
ls ${APPSERVER_AGENT_HOME} && \
rm /tmp/AppServerAgent-${APPSERVER_AGENT_VERSION}.zip

ARG DEPENDENCY=target/dependency
COPY ${DEPENDENCY}/BOOT-INF/lib /app/lib
COPY ${DEPENDENCY}/META-INF /app/META-INF
COPY ${DEPENDENCY}/BOOT-INF/classes /app

# Execute App with AppDynamics Java AppServer Agent
#Envioremental variables
ARG APPD_CONTROLLER_HOSTNAME
ARG APPD_CONTROLLER_PORT
ARG APPD_CONTROLLER_SSL_ENABLED
ARG APPD_AGENT_ACCOUNT_NAME
ARG APPD_AGENT_ACCOUNT_ACCESS_KEY
ARG APPD_AGENT_APPLICATION_NAME
ARG APPD_AGENT_REUSE_NODE_NAME
#Specific project variables
ARG APPD_AGENT_TIER_NAME
ARG APPD_AGENT_REUSE_NODE_NAME_PREFIX

ENV APPDYNAMICS_AGENT_APPLICATION_NAME=$APPD_AGENT_APPLICATION_NAME
ENV APPDYNAMICS_AGENT_TIER_NAME=$APPD_AGENT_TIER_NAME
ENV APPDYNAMICS_AGENT_ACCOUNT_NAME=$APPD_AGENT_ACCOUNT_NAME
ENV APPDYNAMICS_AGENT_ACCOUNT_ACCESS_KEY=$APPD_AGENT_ACCOUNT_ACCESS_KEY
ENV APPDYNAMICS_CONTROLLER_HOST_NAME=$APPD_CONTROLLER_HOSTNAME
ENV APPDYNAMICS_CONTROLLER_PORT=$APPD_CONTROLLER_PORT
ENV APPDYNAMICS_CONTROLLER_SSL_ENABLED=$APPD_CONTROLLER_SSL_ENABLED
ENV APPDYNAMICS_JAVA_AGENT_REUSE_NODE_NAME=$APPD_AGENT_REUSE_NODE_NAME
ENV APPDYNAMICS_JAVA_AGENT_REUSE_NODE_NAME_PREFIX=$APPD_AGENT_REUSE_NODE_NAME_PREFIX

ENTRYPOINT java -cp "app:app/lib/*" \
-Dlog4j2.formatMsgNoLookups=true \
-Dappdynamics.http.proxyHost=EVAPzen.fpl.com -Dappdynamics.http.proxyPort=10262 \
-Dappdynamics.jvm.shutdown.mark.node.as.historical=true \
-javaagent:/opt/appdynamics/AppServerAgent/javaagent.jar \
com.fplws.services.payment.Application
